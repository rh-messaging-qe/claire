# claire-standalone
An ActiveMQ Artemis End-to-End tests suite

## Description
Claire Standalone is an ActiveMQ Artemis test suite focused on system and integration tests using containers.

The test suite uses the [testcontainers]((https://www.testcontainers.org)) library as a base for the deployment of the
infrastructure needed for the tests and uses [yacfg](https://github.com/rh-messaging-qe/yacfg) and
[yacfg_artemis](https://github.com/rh-messaging-qe/yacfg_artemis) to handle ActiveMQ Artemis configuration

## How to run tests
**_NOTES:_** Requires docker installed as podman is not supported yet

Before run the tests you will need to execute the `build` using `make` and provide the `ARTEMIS_INSTALL_ZIP` as 
environment variable or as a parameter to `make`. (See below the note on List of available Environment Variables about 
how to use it)

After the test suite is build, you can execute the tests.
Currently, we support running `test_smoke` (which executes all tests under io.brokerqe.tests.smoke package) and 
`test` (which execute all tests) using `make`. You can also use `make test TEST=The_Test_To_Run` to execute
specific tests. The `TEST` environment variable is passed thur maven and expects the surefire
[test parameter format](https://maven.apache.org/surefire/maven-surefire-plugin/test-mojo.html#test)

Review `Makefile` for more details about the `make` targets

## List of available Configuration settings
The configuration settings can be defined in the file named `standalone.properties`, located in the project directory. 
It is possible to overwrite the value used in the properties file with an environment variable. If no definition is found
in the properties file or in the environment variable, the default value is used.

See the table below for more info.

| Environment Variable          | Description                                     | Default                                                | Possible values                                  |
|-------------------------------|-------------------------------------------------|--------------------------------------------------------|--------------------------------------------------|
| ARTEMIS_INSTALL_ZIP           | URL to download the Artemis binary distribution | not set                                                | \<url\>                                          |
| TEST_LOG_LEVEL                | Set logging level of test suite                 | `INFO` set in `logback.xml`                            | `TRACE`, `DEBUG`, `INFO`, `WARN`, `ERROR`, `OFF` |
| LOGS_LOCATION                 | Location in which to generate collected logs    | `test-logs`                                            | \<directory\>                                    |
| LOG_CONTAINERS                | Enable containers stdout/stderr log             | `false`                                                | `true`, `false`                                  |
| ARTEMIS_CONTAINER_IMAGE       | Artemis container image to use                  | `quay.io/rhmessagingqe/claire-standalone-artemis:ubi9` | Any RedHat based <image_registry>                |
| ARTEMIS_CONTAINER_JAVA_HOME   | Java location inside artemis container          | `/opt/openjdk-java-11`                                 | \<directory\>                                    |
| ZOOKEEPER_CONTAINER_IMAGE     | Zookeeper container image to use                | `zookeeper:latest`                                     | <image_registry>                                 |
| YACFG_ARTEMIS_CONTAINER_IMAGE | yacfg container image to use                    | `quay.io/rhmessagingqe/yacfg_artemis:latest`           | <image_registry>                                 |
| USE_EXISTING_CONFIG           | Path to existing `etc` folder or artemis        | not set                                                | \<directory\>                                    |
| IMAGE_PULL_POLICY             | Image Pull Policy for container images          | `default`                                              | `default`, `always`, `ageBased-1H`               |

**_NOTE:_** `ARTEMIS_INSTALL_ZIP` is not set by default and build it without set the environment variable will fail.
You must set the environment variable or provide it to `make` command, i.e.:
```shell
make build ARTEMIS_INSTALL_ZIP=https://archive.apache.org/dist/activemq/activemq-artemis/2.27.1/apache-artemis-2.27.1-bin.zip
```
or
```shell
export ARTEMIS_INSTALL_ZIP=https://archive.apache.org/dist/activemq/activemq-artemis/2.27.1/apache-artemis-2.27.1-bin.zip
make build
```

**_NOTE:_** `artemis.container.image | ARTEMIS_CONTAINER_IMAGE` is generated by the [docker file](dockerfiles/artemis)

## Setting log level
Currently, there is supported `TEST_LOG_LEVEL` environment variable, which can set desired logging level
of test suite. By default, we use `INFO` level. Supported values are `TRACE`, `DEBUG`, `INFO`, `WARN`,
`ERROR`, `OFF.

## JDBC Database support
Standalone test suite provides support for databases in two ways:
* _Provided DB_ - pass database configuration file into `JDBC_DATA` environment variable
* _Deployed DB_ - pass reserved keyword `mariadb`, `mysql`, `mssql2022`, `oracle23` or `postgresql` into `JDBC_DATA` environment variable

In deployed DB way, relevant _bitnami mariadb/mysql/postgresql_, _container-registry.oracle.com/database/free_ or _mcr.microsoft.com/mssql/server:2022_  container will be spawned and used for testing.

## YACFG Artemis configuration genration tool
- If needed to use custom yacfg, use following exported variables & example command
    ```shell
    export YACFG_TEMPLATES=<repos>/yacfg_artemis/templates
    export YACFG_PROFILES=<repos>/yacfg_artemis/profiles
    cd <repo-yacfg_artemis>
    <path-to-bin>yacfg --profile artemis/<profile>.yaml.jinja2 --tune <path-to>/<test-tune-file>.yaml.jinja2 --output <tuned-artemis-config-dir>

    yacfg --profile artemis/claire-default-profile-2.34.0.yaml.jinja2 \
          --tune claire/standalone-suite/yacfg-profiles/tests/upgrade/HAReplicationUpgradeTests/primary-tune.yaml.jinja2 \
          --output primary-lala
  ```

## Image Pull Policy 
You can configure the `IMAGE_PULL_POLICY` environment variable to control whether container images should be pulled at runtime.
The supported values are:
- **`default`** – Uses the default pull policy (usually skips pulling if the image exists locally).
- **`always`** – Always pulls the image from a registry, regardless of whether it exists locally.
- **`ageBased-1H`** – Pulls the image only if the existing local image is older than 1 hour.
You can also define a Custom pull policy by implementing the `org.testcontainers.images.AbstractImagePullPolicy` class.

## Development Hints
- Keep the code clean :-)
- If you are going to implement a container verify if it already exists on testcontainer modules (go to the modules 
section on testcontainers main page)
- Use the `SingleInstanceSmokeTest` and `FailoverInstancesWithDataReplicationTests` as examples about how to implement
the tests. These classes have some important comments on it
- The `helper` package contains useful classes which helps to create tests specially the `ArtemisJmxHelper` class
- The `client.jms` package contains the client implementations (currently, in an early stage)
- Remember to add the initial header on new files/classes, otherwise the build will fail on checkstyle checks (you may configure your IDE to automatically add the header on new files)
